\documentclass[../thesis.tex]{subfiles}

\begin{document}

\chapter{Calibration}
\label{chap:calib}

\section{Overview}

The Daya Bay DAQ system outputs little more than timestamped PMT hits, grouped into readout windows and tagged with trigger information. These hits take the form of ADC readings from the peak-finding electronics, along with the TDC count at the time that each (shaped) PMT waveform crossed the disciminator's threshold. In order to carry out any sort of physics analysis, it is necessary to first convert this raw ADC and TDC data into the higher-level quantities of photoelectron count and photon arrival time, and then to combine individual channels into event parameters such as energy and position.

This chapter describes the first half of that process; namely, the detector calibration and data processing involved in the channel-by-channel calculation of hit time and charge. These calibrated quantities are fundamental in that they are used in all further analysis stages and by all reconstruction algorithms. Accuracy is vital, as any bias in the channel charge will be reflected in the total event energy and in any (charge-based) vertex reconstruction; likewise, accurate times are important for time-based vertex reconstructions.

\section{Timing calibration}

The timing calibration takes each hit's TDC count\footnote{I.e., the number of ticks that elapsed between the hit and the trigger} and converts it into an estimate of the time at which the photon struck the photocathode. The absolute time is unimportant, but for the purpose of time-based vertex (or track) reconstruction, the \emph{relative} times between channels must be accurately determined. These calibrated times, in addition to their use in vertex reconstruction, are also used in defining the time window for hit selection (performed during the charge calculation, described later).\footnote{Given that this window is 400~ns wide, and the timewalk correction is on the order of a few~ns, the raw times would actually suffice for hit selection.} 

This process involves subtracting out a channel-specific offset (corresponding to cable length, etc.) with an additional correction for the charge-dependent \emph{timewalk effect}, in which smaller pulses take longer than larger ones to cross the discriminator's threshold. The offset, as well as a parameterization of the timewalk curve, is stored in the calibration database and applied to the TDC readings during data processing. We now discuss the preparation of these calibration constants.

\subsection{Calibration constant preparation}

To measure each channel's offset and timewalk profile, we require a well-defined event vertex and an external source of $T_0$ (true event time) information.\footnote{There is a natural variance in the timing of readout triggers, smearing the TDC measurements between different events. Knowledge of $T_0$ effectively provides knowledge of the trigger jitter for each event, allowing it to be subtracted out. Without this information, it is impossible to obtain a useful timewalk curve.} Toward that end, Daya Bay uses LED calibration runs in which the LED is positioned at the center of the detector. When a pulse is sent to the LED, a ``hit'' is also sent to the FEE from a ``fake'' $T_0$ channel (board 18, connector 16). For each PMT hit, we take its TDC count, subtracted from that of the T0 channel, invert (since an earlier hit will have a higher TDC count), convert to nanoseconds (using the known TDC frequency), and then finally subtract the time of flight from the detector center. This gives the \emph{measured time} of each channel in each event.

In the next step, a 2D histogram is constructed for each channel by taking all of the channel's hits (within a reasonable time window), across all events, and plotting each hit's measured time $t$ against its ADC count $q$. This histogram's profile is then fit to the six-parameter functional form
\[ t(q) = a_1 + a_2 \exp (-a_3 q) + a_4 \exp (-a_5 q) + a_6 \log q, \] 
which was empirically found to produce good fits under appropriate restrictions on the parameters.

After a manual verification of fit quality, the six parameters for each channel are uploaded to the database and marked with a suitable validity period. Because $t(q)$ gives the \emph{time since trigger}, which is on the order of a microsecond, a single global $\mu$s-scale offset (the average of all the $a_1$'s, to be precise) is subtracted from each $a_1$. This ensures that when we later use $t(q)$ as a \emph{correction}, we don't apply a large offset to the times we are correcting.

Whenever the electronics have been modified in a way that could affect the timing (such as a cabling change or board replacement), a new set of constants is prepared for the affected AD, using this same procedure.

\begin{comment}
Show the tof-corrected times; comment on TDC discretization.
\end{comment}

\subsection{Calculation of corrected times}

Once the calibration parameters are in the database, applying them to the raw data is straightforward. For each hit, we take the ADC count $q$ and plug it into the function $t(q)$, with the parameters taken from the database. Then, using the channel's raw TDC count $N$, the calibrated time $t_c$ is calculated as
\[ t_c = -\frac{N}{f_\mathrm{TDC}} - t(q), \]
where $f_\mathrm{TDC}$ is the TDC frequency. After this is done, we have a calibrated time, in ns, for each hit, which can be directly and accurately compared to other hits in other channels, regardless of how much charge each channel saw and regardless of intrinsic variations between channels.

\end{document}